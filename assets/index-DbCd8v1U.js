(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function s(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(a){if(a.ep)return;a.ep=!0;const n=s(a);fetch(a.href,n)}})();const ee={generate(t,e,s){const i=document.createElement("canvas");i.width=t,i.height=e;const a=i.getContext("2d");return s(a),i},stretch(t,e,s,i=10,a=1){const n=t.width,r=t.height,o=document.createElement("canvas");o.width=e,o.height=s;const u=o.getContext("2d");u.globalAlpha=a;const p=[0,i,e-i,e],l=[0,i,s-i,s],f=[0,i,n-i,n],h=[0,i,r-i,r];for(let d=0;d<3;d++)for(let w=0;w<3;w++){const P=f[w],I=h[d],W=f[w+1]-f[w],X=h[d+1]-h[d],_e=p[w],ge=l[d],xe=p[w+1]-p[w],we=l[d+1]-l[d];u.drawImage(t,P,I,W,X,_e,ge,xe,we)}return u.globalAlpha=1,o}};class ye{constructor(e){this.compare=e}data=[];push(e){this.data.push(e),this.bubbleUp()}pop(){if(this.size()===0)return;const e=this.data[0],s=this.data.pop();return this.size()>0&&(this.data[0]=s,this.bubbleDown()),e}peek(){return this.data[0]}size(){return this.data.length}bubbleUp(){let e=this.data.length-1;for(;e>0;){const s=e-1>>1;if(this.compare(this.data[e],this.data[s])>=0)break;[this.data[e],this.data[s]]=[this.data[s],this.data[e]],e=s}}bubbleDown(){let e=0;const s=this.data.length;for(;;){const i=2*e+1,a=2*e+2;let n=e;if(i<s&&this.compare(this.data[i],this.data[n])<0&&(n=i),a<s&&this.compare(this.data[a],this.data[n])<0&&(n=a),n===e)break;[this.data[e],this.data[n]]=[this.data[n],this.data[e]],e=n}}}class N{_time=0;_heap;static _default=new N;constructor(){this._heap=new ye((e,s)=>e.scheduledAt-s.scheduledAt)}update(e){for(this._time+=e;;){const s=this._heap.peek();if(!s||s.scheduledAt>this._time)break;this._heap.pop()?.action()}}static update(e){this._default.update(e)}after(e,s){this._heap.push({scheduledAt:this._time+e,action:s})}static after(e,s){this._default.after(e,s)}every(e,s,i,a){const n=this._time+e,r=this._time+s;for(let o=n;o<=r;o+=e)this._heap.push({scheduledAt:o,action:i});a&&this._heap.push({scheduledAt:r,action:a})}static every(e,s,i,a){this._default.every(e,s,i,a)}removeAllTimers(){for(;this._heap.size()>0;)this._heap.pop()}static removeAllTimers(){this._default.removeAllTimers()}}class J{static _alpha=0;static _accumulator=0;static _fps=0;static _lastTime=performance.now();static timeStep=1/60;static get lastTime(){return this._lastTime}static get fps(){return Math.floor(this._fps)}static get alpha(){return this._alpha}static update(e,s){const i=(e-this._lastTime)/1e3;for(this._fps=1/i,this._lastTime=e,this._accumulator+=i;this._accumulator>=this.timeStep;)s(this.timeStep),this._accumulator-=this.timeStep;this._alpha=this._accumulator/this.timeStep}}class ve{_ctx;_draws=0;get drawCount(){return this._draws}constructor(e){this._ctx=e}startFrame(e="#00000000"){this._draws=0,this._ctx.fillStyle=e,this._ctx.fillRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height),this._ctx.fillStyle="#ffffff"}drawRect(e,s,i,a,n){this._draws+=1,this._ctx.fillStyle=n,this._ctx.fillRect(e,s,i,a)}drawImage(e,s,i){this._draws+=1,this._ctx.drawImage(e,s,i)}drawText(e,s,i,a={}){this._draws+=1,a.font&&(this._ctx.font=a.font);const n=this._ctx.measureText("Hg"),r=n.actualBoundingBoxAscent+n.actualBoundingBoxDescent,o=this._ctx.measureText(e);let u=a.lines===1?n.hangingBaseline-r/2:0;if(a.width&&o.width>a.width){const p=this._ctx.measureText(" ").width,l=a.width,f=e.split(" ").reverse();let h=0,d=0,w=a.lines??1;for(;d<w;){let P="",I=0;for(;f.length>0;){let W=f.pop(),X=this._ctx.measureText(W).width;if(h+X>l){f.push(W);break}else P+=W+=" ",h+=X+=p}switch(I=0,a.align){case"center":I-=h/2;break;case"right":I-=h;break}this._ctx.fillStyle=a.color??"#ffffff",this._ctx.fillText(P,s+I,i+u),d+=1,h=0,u+=r}this._draws+=1}else{switch(a.align){case"center":s-=o.width/2;break;case"right":s-=o.width;break}this._draws+=1,this._ctx.fillStyle=a.color??"#ffffff",this._ctx.fillText(e,s,i+u)}}drawSprite(e,s,i,a,n=0,r=0){this._draws+=1,this._ctx.drawImage(e,s.x,s.y,s.w,s.h,i+n,a+r,s.w,s.h)}applyCamera(e){e?(this._ctx.save(),this._ctx.scale(e.scale,e.scale),this._ctx.translate(-e.pos.x,-e.pos.y)):this._ctx.restore()}}class te{async init(){}deinit(){}}class C{constructor(e,s){this.width=e,this.height=s}_scenes=[{async init(){},deinit(){},update(){},draw(){}}];get current(){return this._scenes[this._scenes.length-1]}async switch(e){await e.init(),this._scenes=[e]}async push(e){await e.init(),this._scenes.push(e)}pop(){return this._scenes.length>1?(this._scenes.pop(),!0):!1}update(e){this._scenes[this._scenes.length-1].update(e)}draw(e){for(let s of this._scenes)s.draw(e)}}const k={rect(t,e,s,i){return{kind:"rect",x:t,y:e,w:s,h:i}},circle(t,e,s){return{kind:"circle",x:t,y:e,r:s}},min(t){return{x:t.x,y:t.y}},mid(t){switch(t.kind){case"circle":return{x:t.x+t.r,y:t.y+t.r};case"rect":return{x:t.x+t.w/2,y:t.y+t.h/2}}},max(t){switch(t.kind){case"circle":return{x:t.x+t.r*2,y:t.y+t.r*2};case"rect":return{x:t.x+t.w,y:t.y+t.h}}},containsPoint(t,e){switch(t.kind){case"circle":return be(t,e);case"rect":return Se(t,e)}},intersects(t,e){switch(t.kind){case"rect":switch(e.kind){case"rect":return Le(t,e);case"circle":return ie(e,t)}case"circle":switch(e.kind){case"rect":return ie(t,e);case"circle":return Me(t,e)}}}};function Se(t,e){const s=t.x+t.w,i=t.y+t.h;return e.x>=t.x&&e.x<=s&&e.y>=t.y&&e.y<=i}function be(t,e){const s=t.x+t.r,i=t.y+t.r,a=s-e.x,n=i-e.y;return a*a+n*n<=Math.pow(t.r,2)}function Me(t,e){const s=t.x-e.x,i=t.y-e.y,a=s*s+i*i,n=t.r+e.r;return a<n*n}function ie(t,e){const s=t.x+t.r,i=t.y+t.r,a=Math.max(e.x,Math.min(s,e.x+e.w)),n=Math.max(e.y,Math.min(i,e.y+e.h)),r=s-a,o=i-n;return r*r+o*o<t.r*t.r}function Le(t,e){return t.x<e.x+e.w&&t.x+t.w>e.x&&t.y<e.y+e.h&&t.y+t.h>e.y}function ke(t){return t.replace(/^(?:\r\n|\r|\n)+|(?:\r\n|\r|\n)+$/g,"")}function de(t){const e={name:t.tagName,attributes:{},children:[]};for(const s of t.attributes)e.attributes[s.name]=s.value;for(const s of t.childNodes)if(s.nodeType===Node.ELEMENT_NODE)e.children.push(de(s));else if(s.nodeType===Node.TEXT_NODE&&s.textContent){const i=ke(s.textContent);i&&(e.text=i)}return e}const O={parse(t){let e;try{e=new DOMParser().parseFromString(t,"application/xml")}catch(a){throw new Error("XML Parse Error: "+(a instanceof Error?a.message:String(a)))}const s=e.querySelector?.("parsererror");if(s)throw new Error("XML Parse Error: "+s.textContent);const i=e.documentElement;return de(i)},findNodes(t,e,s){const i=[];function a(n){n.name===e&&(!s||O.matchAttributes(n,s))&&i.push(n);for(const r of n.children)a(r)}return a(t),i},matchAttributes(t,e){for(const[s,i]of Object.entries(e))if(t.attributes[s]!==i)return!1;return!0}},c={new(t,e){return{x:t,y:e}},get zero(){return{x:0,y:0}},fromAngle(t){return{x:Math.cos(t),y:Math.sin(t)}},add(t,e){return{x:t.x+e.x,y:t.y+e.y}},sub(t,e){return{x:t.x-e.x,y:t.y-e.y}},mul(t,e){return{x:t.x*e,y:t.y*e}},lerp(t,e,s){return{x:t.x+(e.x-t.x)*s,y:t.y+(e.y-t.y)*s}},clone(t){return{x:t.x,y:t.y}},length(t){return Math.hypot(t.x,t.y)},normalize(t){const e=c.length(t);return e===0?{x:0,y:0}:c.mul(t,1/e)},isEqual(t,e){return t.x===e.x&&t.y===e.y}};class R{children;minSize;stretch;spacing;expSize=null;frame=null;constructor(e,s={w:0,h:0},i="all",a){this.children=e,this.minSize=s,this.stretch=i,this.spacing=a}reshape(e,s,i,a){this.expand(),this.layout(k.rect(e,s,i,a))}*widgets(){for(const e of this.children)yield*e.widgets()}expand(){for(const e of this.children)e.expand();this.expandChildren()}layout(e){this.layoutChildren(e);for(const s of this.children)s.frame&&s.layout(s.frame)}static spread(e,s){const i=s.map(([h])=>h),a=s.map(([,h])=>h),n=i.reduce((h,d)=>h+d,0),r=Math.max(0,e-n),o=a.reduce((h,d)=>h+d,0),u=o>0?Math.floor(r/o):0,p=a.map(h=>h*u),l=p.reduce((h,d)=>h+d,0),f=r-l;if(f!==0){const h=a.map((d,w)=>[d,w]).filter(([d])=>d>0).map(([,d])=>d).pop();h!==void 0&&(p[h]+=f)}return i.map((h,d)=>h+p[d])}}class Ee extends R{widget;constructor(e,s={w:0,h:0},i="all"){super([],s,i,0),this.widget=e}*widgets(){yield this.widget}expandChildren(){this.expSize=this.minSize}layoutChildren(e){this.widget.setFrame(e)}}class Ne extends R{margin;constructor(e,s={w:0,h:0},i="all",a={l:0,t:0,r:0,b:0}){super(e,s,i,0),this.margin=a}expandChildren(){let e=0,s=0;for(const i of this.children)i.expSize&&(e=Math.max(e,i.expSize.w),s=Math.max(s,i.expSize.h));this.expSize={w:e+this.margin.l+this.margin.r,h:s+this.margin.t+this.margin.b}}layoutChildren(e){const{l:s,t:i,r:a,b:n}=this.margin,r=e.x+s,o=e.y+i,u=e.w-s-a,p=e.h-i-n;this.frame=k.rect(r,o,u,p);for(const l of this.children)l.frame=k.rect(r,o,u,p)}}class Ce extends R{expandChildren(){let e=0,s=0;for(const i of this.children)i.expSize&&(e=Math.max(e,i.expSize.w),s+=i.expSize.h);s+=Math.max(0,this.children.length-1)*this.spacing,this.expSize={w:e,h:s}}layoutChildren(e){const s=Math.max(0,this.children.length-1)*this.spacing,i=R.spread(e.h-s,this.children.map(n=>[n.expSize?.h??0,n.stretch==="vertical"||n.stretch==="all"?1:0]));let a=e.y;for(let n=0;n<this.children.length;++n){const r=this.children[n],o=i[n],u=r.stretch==="horizontal"||r.stretch==="all"?e.w:r.expSize?.w??0;r.frame=k.rect(e.x,a,u,o),a+=o+this.spacing}}}class Pe extends R{expandChildren(){let e=0,s=0;for(const i of this.children)i.expSize&&(e+=i.expSize.w,s=Math.max(s,i.expSize.h));e+=Math.max(0,this.children.length-1)*this.spacing,this.expSize={w:e,h:s}}layoutChildren(e){const s=Math.max(0,this.children.length-1)*this.spacing,i=R.spread(e.w-s,this.children.map(n=>[n.expSize?.w??0,n.stretch==="horizontal"||n.stretch==="all"?1:0]));let a=e.x;for(let n=0;n<this.children.length;++n){const r=this.children[n],o=i[n],u=r.stretch==="vertical"||r.stretch==="all"?e.h:r.expSize?.h??0;r.frame=k.rect(a,e.y,o,u),a+=o+this.spacing}}}const y={border(t,e={}){return new Ne(Array.isArray(t)?t:[t],e.minSize??{w:0,h:0},e.stretch??"all",e.margin??{t:0,b:0,l:0,r:0})},hstack(t,e={}){return new Pe(Array.isArray(t)?t:[t],{w:0,h:0},e.stretch??"horizontal",e.spacing??0)},vstack(t,e={}){return new Ce(Array.isArray(t)?t:[t],{w:0,h:0},e.stretch??"vertical",e.spacing??0)},elem(t,e={}){return new Ee(t,e.minSize??{w:0,h:0},e.stretch??"none")},size(t,e){return{w:t,h:e}},margin(t,e,s,i){return{l:t,t:e,r:s,b:i}}},Ie={new(t){const e=[],s=t.attributes.imagePath,i=O.findNodes(t,"SubTexture");for(let a of i)e.push({x:Number(a.attributes.x),y:Number(a.attributes.y),w:Number(a.attributes.width),h:Number(a.attributes.height)});return{image:ze(s),sprites:e}}};function ze(t){const e=t.split("/").pop()?.split("\\").pop()?.split(".")||[];return e.length<=1?e[0]||"":(e.pop(),e.join("."))}function $(t){const e=t.split("/").pop()?.split("\\").pop()?.split(".")||[];return e.length<=1?e[0]||"":(e.pop(),e.join("."))}const Be=[".png",".jpg"],De=[".wav",".mp3",".ogg"],Fe=[".ttf"];class M{_imageRegistry=new Map;_audioRegistry=new Map;_xmlRegistry=new Map;_spriteSheetRegistry=new Map;getImage(e){return this._imageRegistry.get(e)}getAudio(e){return this._audioRegistry.get(e)}getXml(e){return this._xmlRegistry.get(e)}getSpriteSheet(e){return this._spriteSheetRegistry.get(e)}async preload(){try{const e=await fetch("assets/manifest.json");if(!e.ok)throw new Error(`Failed to load manifest: ${e.statusText}`);const s=await e.json();console.log("Manifest loaded:",s);for(const i of s.assets){const a=`assets/${i}`;if(console.log(`Loading asset: ${a}`),Be.some(n=>a.endsWith(n))){const n=new Image;n.src=a,await n.decode(),this._imageRegistry.set($(i),n);continue}if(De.some(n=>a.endsWith(n))){const n=new Audio(a);n.load(),this._audioRegistry.set($(i),n);continue}if(Fe.some(n=>a.endsWith(n))){const n=$(i),r=new FontFace(n,`url(${a})`);await r.load(),document.fonts.add(r);continue}if(a.endsWith(".xml")){const r=await(await fetch(a)).text(),o=O.parse(r);this._xmlRegistry.set($(i),o);continue}}}catch(e){console.error("Error loading manifest:",e)}}loadSpriteSheet(e){const s=this.getXml(e),i=Ie.new(s);this._spriteSheetRegistry.set(i.image,i.sprites)}}const ae={true(t,e){if(!t)throw new Error(e)},defined(t,e){if(!t)throw new Error(e)},false(t,e){if(t)throw new Error(e)}};var L=(t=>(t[t.DPadU=1]="DPadU",t[t.DPadD=2]="DPadD",t[t.DPadL=4]="DPadL",t[t.DPadR=8]="DPadR",t[t.ButtonA=16]="ButtonA",t[t.ButtonB=32]="ButtonB",t[t.ButtonX=64]="ButtonX",t[t.ButtonY=128]="ButtonY",t[t.ButtonL=256]="ButtonL",t[t.ButtonR=512]="ButtonR",t[t.Start=1024]="Start",t[t.Select=2048]="Select",t))(L||{});class Q{_keyboardInputMap;_gamepadInputMap;_heldKeys=new Set;_mousePos=c.new(-1,-1);_isMouseDown=!1;_isMouseClicked=!1;_stateBuffer=[0,0];_stateIdx=0;constructor(e){this._keyboardInputMap=new Map([["w",1],["s",2],["a",4],["d",8],["backspace",16],["enter",1024],["escape",2048]]),this._gamepadInputMap=new Map([[12,1],[13,2],[14,4],[15,8],[0,16],[1,32],[2,64],[3,128],[4,256],[5,512],[8,1024],[9,2048]]),window.addEventListener("keydown",s=>{s.preventDefault(),this._heldKeys.add(s.key.toLowerCase())}),window.addEventListener("keyup",s=>{s.preventDefault(),this._heldKeys.delete(s.key.toLowerCase())}),window.addEventListener("mousedown",s=>{this._isMouseDown=!0}),window.addEventListener("mouseup",s=>{this._isMouseDown=!1,this._isMouseClicked=!0}),window.addEventListener("mousemove",s=>{const i=e.getBoundingClientRect();this._mousePos.x=s.clientX-i.left,this._mousePos.y=s.clientY-i.top}),window.addEventListener("gamepadconnected",s=>{console.log("Gamepad connected:",s.gamepad)}),window.addEventListener("gamepaddisconnected",s=>{console.log("Gamepad disconnected:",s.gamepad)})}update(){this._stateIdx=1-this._stateIdx;var e=0;this._isMouseClicked=!1;const i=navigator.getGamepads()[0];if(i)for(let[a,n]of this._gamepadInputMap)i.buttons[a].pressed&&(e|=n);for(const a of this._heldKeys){const n=this._keyboardInputMap.get(a);n&&(e|=n)}this._stateBuffer[this._stateIdx]=e}isInputDown(e){return(this._stateBuffer[this._stateIdx]&e)!==0}isInputReleased(e){const s=this._stateBuffer[this._stateIdx],i=this._stateBuffer[1-this._stateIdx];return(s&e)!==0&&(i&e)===0}getMousePosition(){return{x:this._mousePos.x,y:this._mousePos.y}}get isMouseDown(){return this._isMouseDown}get isMouseClicked(){return this._isMouseClicked}}class x{static services=new Map;static register(e,s){this.services.set(e,s)}static resolve(e){if(!this.services.has(e))throw new Error(`No service registered of type: ${e.name}.`);return this.services.get(e)}}class ne{pos=c.zero;scale=1;applyTransform(e){e.translate(-this.pos.x*this.scale,-this.pos.y*this.scale),e.scale(this.scale,this.scale)}toWorld(e,s){return{x:e/this.scale+this.pos.x,y:s/this.scale+this.pos.y}}toScreen(e,s){return{x:(e-this.pos.x)*this.scale,y:(s-this.pos.y)*this.scale}}}class U{_state=0;_isEnabled=!0;set isEnabled(e){this._isEnabled=e,this.setState(this._isEnabled?0:3)}get isEnabled(){return this._isEnabled}_frame=k.rect(0,0,0,0);get state(){return this._state}setState(e){this._state=e}get frame(){return this._frame}setFrame(e){this._frame=k.rect(e.x,e.y,e.w,e.h)}update(e){}}class Re extends U{_image;_ox=0;_oy=0;constructor(e,s){super(),this._image=e}set image(e){this._image=e,this._ox=Math.floor((this.frame.w-this._image.width)/2),this._oy=Math.floor((this.frame.h-this._image.height)/2)}draw(e){this._image&&e.drawImage(this._image,this.frame.x+this._ox,this.frame.y+this._oy)}}class ue extends U{_ox=0;_oy=0;_font;_text;_lines;_textColor;_fontSize;set text(e){this._text=e}get text(){return this._text}constructor(e,s){super(),this._lines=s.lines,this._textColor=s.textColor,this._fontSize=s.fontSize,this._font=`${this._fontSize}px ${s.font}`,this._text=e}setFrame(e){super.setFrame(e),this._ox=e.x+Math.floor(e.w/2),this._oy=e.y+Math.floor(e.h/2)}draw(e){const s=this.state===3?Ge(this._textColor,.4):this._textColor;e.drawText(this._text,this._ox,this._oy,{font:this._font,align:"center",color:s,lines:this._lines,width:this.frame.w})}}class We extends U{_background;_imageName;constructor(e){super(),this._imageName=e}draw(e){e.drawImage(this._background,this._frame.x,this._frame.y)}setFrame(e){super.setFrame(e);const i=x.resolve(M).getImage(this._imageName);this._background=ee.stretch(i,e.w,e.h)}}class Te extends ue{_background;_onClick;_stateBackgrounds=new Map;set isEnabled(e){super.isEnabled=e;let s=this.isEnabled?0:3;this._background=this._stateBackgrounds.get(s)}constructor(e,s){super(e,s),this._onClick=s?.onClick?s.onClick:()=>{}}setFrame(e){super.setFrame(e);const s=x.resolve(M),i=new Map([[0,"button_square_depth_flat"],[1,"button_square_depth_gloss"],[2,"button_square_gloss"],[3,"button_square_depth_flat"]]);for(let[a,n]of i){const r=a===3?.5:1;let o=s.getImage(n);o=ee.stretch(o,e.w,e.h,10,r),this._stateBackgrounds.set(a,o)}this._background=this._stateBackgrounds.get(0)}setState(e){super.setState(e),this._background=this._stateBackgrounds.get(this.state)}draw(e){e.drawImage(this._background,this.frame.x,this.frame.y),super.draw(e)}update(e){if(this.state===3)return;const s=k.containsPoint(this._frame,g.mouse.pos),i=s&&g.mouse.buttonState==="down",a=this.state===2&&g.mouse.buttonState==="up";if(s?this.setState(1):this.setState(0),i&&!a){const n=g.mouse.buttonState==="down"?2:1;this.setState(n)}a&&(this._onClick(),this.setState(0))}}class Ae extends U{draw(e){}}class g{static panel(e="button_square_border"){return y.elem(new We(e),{minSize:{w:0,h:0},stretch:"all"})}static label(e,s){let i=s?.fontSize??24,a=s?.lines??1;return y.elem(new ue(e,{textColor:s?.textColor??"#eeeeee",font:s?.font??"PoetsenOne",fontSize:i,lines:a,width:0}),{minSize:{w:s?.width??0,h:a*i},stretch:"horizontal"})}static button(e,s){let i=s?.fontSize??24,a=s?.lines??1;s?.size;const n=s?.onClick?s.onClick:()=>{};return y.elem(new Te(e,{textColor:s?.textColor??"#eeeeee",font:s?.font??"PoetsenOne",fontSize:i,lines:a,size:{w:0,h:0},width:0,normalImage:s?.normalImage??"button_square_depth_flat",hoverImage:s?.hoverImage??"button_square_depth_gloss",activeImage:s?.activeImage??"button_square_gloss",onClick:n}),{minSize:{w:s?.width??192,h:64},stretch:"horizontal"})}static imageView(e,s){const i=s?.size??{w:0,h:0},a=s?.stretch??"all";return y.elem(new Re(e,s),{minSize:i,stretch:a})}static flexSpace(e){return y.elem(new Ae,{stretch:e})}static _mouse={pos:{x:0,y:0},buttonState:"none"};static get mouse(){return this._mouse}static init(e){window.addEventListener("mousedown",s=>{this._mouse.buttonState="down"}),window.addEventListener("mouseup",s=>{this._mouse.buttonState="up"}),window.addEventListener("mousemove",s=>{const i=e.getBoundingClientRect();this._mouse.pos.x=s.clientX-i.left,this._mouse.pos.y=s.clientY-i.top})}static update(){this._mouse.buttonState==="up"&&(this._mouse.buttonState="none")}}function Ge(t,e){const s=a=>Math.round(Math.max(0,Math.min(1,a))*255).toString(16).padStart(2,"0");return`#${t.replace(/^#/,"")}${s(e)}`}const v=64,S=64,A=22*48,G=19*48;var m=(t=>(t[t.Floor=0]="Floor",t[t.Wall=1]="Wall",t[t.Player=2]="Player",t[t.Box=3]="Box",t[t.Goal=4]="Goal",t))(m||{}),b=(t=>(t[t.Idle=0]="Idle",t[t.Move=1]="Move",t[t.Push=2]="Push",t))(b||{});const _={None:c.zero,N:c.new(0,-1),S:c.new(0,1),W:c.new(-1,0),E:c.new(1,0),NW:c.new(-1,-1),SW:c.new(-1,1),SE:c.new(1,1),NE:c.new(1,-1)},B={playSound(t){const s=x.resolve(M).getAudio(t);s.currentTime=0,s.play()},playRandomFootstep(){const t=Math.floor(Math.random()*4);this.playSound("footstep_concrete_00"+t)}},Oe=Math.floor(.2*60),E={idle(t){return{type:b.Idle,dir:t}},move(t,e){return B.playRandomFootstep(),{type:b.Move,frame:0,pos:t,dir:e}},push(t,e,s){return B.playRandomFootstep(),B.playSound("push"),{type:b.Push,frame:0,pos:t,dir:e,box:s}},update(t,e,s){const i=e.player;switch(t.type){case b.Idle:if(t.dir){let a=me(t.dir);i.spriteIndex=a[a.length-1]}return;case b.Move:re(i,t,()=>{e.moves.push({type:t.type,dir:t.dir})});break;case b.Push:re(i,t,()=>{e.moves.push({type:t.type,dir:t.dir})}),t.box.pos=c.add(i.pos,t.dir);break}}};function re(t,e,s){const i=c.add(e.pos,e.dir);e.frame+=1;const a=e.frame/Oe,n=me(e.dir),r=Math.floor(e.frame/n.length);t.spriteIndex=n[r],a>=1?(t.pos=i,t.action=E.idle(),s()):t.pos=c.lerp(e.pos,i,a)}function me(t){let e=[86,85,87,85];return c.isEqual(t,_.S)&&(e=[83,82,84,82]),c.isEqual(t,_.W)&&(e=[98,97,99,97]),c.isEqual(t,_.E)&&(e=[95,94,96,94]),e}const V={player(t,e){return{type:m.Player,pos:{x:t,y:e},lastPos:{x:t,y:e},action:E.idle(),spriteIndex:82}},box(t,e){return{type:m.Box,pos:{x:t,y:e},lastPos:{x:t,y:e},spriteIndex:10}},goal(t,e){return{type:m.Goal,pos:{x:t,y:e}}}},D={new(t,e){const s=[];for(let i=0;i<e;i++)for(let a=0;a<t;a++){let n=i*t+a;s[n]=m.Floor}return{w:t,h:e,values:s}},setTile(t,e,s,i){t.values[s*t.w+e]=i},getTile(t,e,s){return t.values[s*t.w+e]}},j="state.json",F={parse(t,e){const s=O.findNodes(t,"Level");ae.true(e<s.length,"Index out of bounds.");const i=s[e],a=Number(i.attributes.Width),n=Number(i.attributes.Height),r=D.new(a,n),o=[],u=[];let p;for(let l=0;l<i.children.length;l++){const h=i.children[l].text??"";for(let d=0;d<h.length;d++){const w=h[d];for(let P of qe(w))switch(D.setTile(r,d,l,m.Floor),P){case m.Floor:continue;case m.Wall:D.setTile(r,d,l,m.Wall);continue;case m.Player:p=V.player(d,l);continue;case m.Box:o.push(V.box(d,l));continue;case m.Goal:u.push(V.goal(d,l));continue}}}return ae.defined(p,"No player found in level."),{index:e,grid:r,player:p,boxes:o,goals:u,turns:0,moves:[]}},save(t){const e=JSON.stringify(t);localStorage.setItem(j,e)},load(){const t=localStorage.getItem(j);if(t!==null)return JSON.parse(t)},reset(){localStorage.removeItem(j)}};function*qe(t){switch(t){case" ":yield m.Floor;return;case"#":yield m.Wall;return;case"@":yield m.Player;return;case"+":yield m.Player,yield m.Goal;return;case"$":yield m.Box;return;case"*":yield m.Box,yield m.Goal;return;case".":yield m.Goal;return}throw new Error(`No entity type defined for character: ${t}`)}const oe={generateBackground(t){const e=t.grid.w*v,s=t.grid.h*S,i=t.player.pos,a=Array.from({length:s},()=>Array(e).fill(!1)),n=[_.N,_.W,_.S,_.E,_.NW,_.SW,_.NE,_.SE],r=[i];for(;r.length>0;){const l=r.pop();if(!(l.x<0||l.x>=e||l.y<0||l.y>=s)&&!a[l.y][l.x]){if(D.getTile(t.grid,l.x,l.y)===m.Wall){a[l.y][l.x]=!0;continue}a[l.y][l.x]=!0;for(let f of n)r.push(c.add(l,f))}}const o=x.resolve(M),u=o.getImage("sokoban_spritesheet"),p=o.getSpriteSheet("sokoban_spritesheet");return ee.generate(e,s,l=>{for(let f=0;f<t.grid.h;f++)for(let h=0;h<t.grid.w;h++){if(!a[f][h])continue;switch(D.getTile(t.grid,h,f)){case m.Wall:Y(l,u,p[1],h*v,f*S);break;default:Y(l,u,p[69],h*v,f*S);break}}for(let f of t.goals)Y(l,u,p[72],f.pos.x*v,f.pos.y*S)})}};function Y(t,e,s,i,a){t.drawImage(e,s.x,s.y,s.w,s.h,i,a,s.w,s.h)}class H{_blocked;constructor(e){this._blocked=Array.from({length:e.h},()=>Array(e.w).fill(!1));for(let s=0;s<e.h;s++)for(let i=0;i<e.w;i++)this._blocked[s][i]=D.getTile(e,i,s)===m.Wall}static forLevel(e){return new H(e.grid)}isBlocked(e,s){return this._blocked[s][e]}}const le={loadLevel(t){const e=localStorage.getItem("levels.xml");if(e!==null){let a=O.parse(e);return F.parse(a,t)}const i=x.resolve(M).getXml("levels");return F.parse(i,t)}};class se extends te{_level;_background;_inputListener;_camera;_movementMap;_nextDir=c.zero;_checkFinished=!0;_revertDelay=0;constructor(e){super(),typeof e=="number"?this._level=le.loadLevel(Number(e)):this._level=e,this._inputListener=x.resolve(Q),this._background=oe.generateBackground(this._level),this._movementMap=H.forLevel(this._level),this._camera=new ne,this._camera.scale=.75;const s=Math.floor(A/v/this._camera.scale),i=Math.floor(G/S/this._camera.scale);this._camera.pos.x=-((s-this._level.grid.w)/2)*v,this._camera.pos.y=-((i-this._level.grid.h)/2)*S}start(){this._level=le.loadLevel(0),this._background=oe.generateBackground(this._level),this._movementMap=H.forLevel(this._level),this._camera=new ne,this._camera.scale=.75;const e=Math.floor(A/v/this._camera.scale),s=Math.floor(G/S/this._camera.scale);this._camera.pos.x=-((e-this._level.grid.w)/2)*v,this._camera.pos.y=-((s-this._level.grid.h)/2)*S}update(e){if(this._revertDelay=Math.max(this._revertDelay-e,0),this._inputListener.isInputReleased(L.Start)&&he(this._level.index),this._inputListener.isInputReleased(L.Select)&&(F.save(this._level),Xe()),this._level.player.action.type===b.Idle&&this._inputListener.isInputDown(L.ButtonA)&&this._revertDelay===0&&(this.tryRevertMove(),this._revertDelay=.15),this._nextDir=_.None,this._inputListener.isInputDown(L.DPadU)?this._nextDir=_.N:this._inputListener.isInputDown(L.DPadL)?this._nextDir=_.W:this._inputListener.isInputDown(L.DPadD)?this._nextDir=_.S:this._inputListener.isInputDown(L.DPadR)&&(this._nextDir=_.E),this._level.player.action.type===b.Idle){if(this._checkFinished){this._checkFinished=!1;let s=this._level.goals.map(n=>n.pos),i=Array.from(this._level.boxes),a=i.length;for(let n of i){n.spriteIndex=20;for(let r=0;r<s.length;r++)if(c.isEqual(n.pos,s[r])){n.spriteIndex=10,a-=1,s.splice(r,1);break}}a===0&&(N.after(.2,()=>B.playSound("jingles_SAX02")),N.after(1,()=>he(this._level.index+1)))}if(this._nextDir!==_.None){const s=c.clone(this._nextDir),i=this.tryMove(s),a=!i&&this.tryPush(s);(i||a)&&(this._level.turns+=1),a&&(this._checkFinished=!0)}}this._level.player.lastPos=c.clone(this._level.player.pos);for(let s of this._level.boxes)s.lastPos=c.clone(s.pos);E.update(this._level.player.action,this._level,e)}draw(e){e.applyCamera(this._camera),e.drawImage(this._background,0,0);const s=x.resolve(M),i=s.getImage("sokoban_spritesheet"),a=s.getSpriteSheet("sokoban_spritesheet"),n=r=>{const o=a[r.spriteIndex],u=(v-o.w)/2,p=(S-o.h)/2,l=c.lerp(r.lastPos,r.pos,J.alpha);e.drawSprite(i,o,Math.floor(l.x*v),Math.floor(l.y*S),u,p)};for(let r of this._level.boxes)n(r);n(this._level.player),e.applyCamera()}hasWall(e){return this._movementMap.isBlocked(e.x,e.y)}tryGetBox(e){for(let s of this._level.boxes)if(c.isEqual(s.pos,e))return s}tryRevertMove(){let e=this._level.moves.pop();if(!e)return;let s=this._level.player,i=$e(e.dir);if(e.type===b.Push){let n=c.add(s.pos,e.dir),r=this.tryGetBox(n);r&&(r.pos=c.add(r.pos,i),r.lastPos=c.clone(r.pos))}s.pos=c.add(s.pos,i),s.lastPos=c.clone(s.pos);let a=this._level.moves[this._level.moves.length-1];a?s.action=E.idle(a.dir):s.action=E.idle(_.S)}tryMove(e){const s=this._level.player.pos,i=c.add(s,e);return this.hasWall(i)||this.tryGetBox(i)?!1:(this._level.player.action=E.move(s,e),!0)}tryPush(e){const s=this._level.player.pos,i=c.add(s,e),a=this.tryGetBox(i);if(!a)return!1;const n=c.add(i,e);return this.hasWall(n)||this.tryGetBox(n)?!1:(this._level.player.action=E.push(s,e,a),!0)}}function he(t){x.resolve(C).switch(new se(t))}function Xe(){x.resolve(C).switch(new fe)}function $e(t){return c.mul(t,-1)}class fe extends te{_level;_guideView=g.imageView(void 0,{size:{w:320,h:256},stretch:"horizontal"});_guideLabel=g.label("",{textColor:"#b48000",lines:2});_guide=[{imageName:"walk-push_1",description:"Push a box to move it"},{imageName:"walk-push_2",description:"Push a box to move it"},{imageName:"walk-push_3",description:"Push a box to move it"},{imageName:"walk-push_3",description:"Push a box to move it"},{imageName:"push-goal_1",description:"Move boxes on goals"},{imageName:"push-goal_2",description:"Move boxes on goals"},{imageName:"push-goal_3",description:"Move boxes on goals"},{imageName:"push-goal_3",description:"Move boxes on goals"},{imageName:"finish_1",description:"Win by moving each box on a goal"},{imageName:"finish_2",description:"Win by moving each box on a goal"},{imageName:"finish_3",description:"Win by moving each box on a goal"},{imageName:"finish_3",description:"Win by moving each box on a goal"}];_guideStep=this._guide.length-1;_resetLevelsButton=g.button("Reset Levels",{fontSize:32,textColor:"#b48000",onClick:async()=>await this.resetLevels().then(()=>this.updateUI())});_importLevelsButton=g.button("Import Levels",{fontSize:32,textColor:"#b48000",onClick:async()=>await this.importLevels().then(()=>this.updateUI())});_continueButton=g.button("Continue",{fontSize:32,textColor:"b48000",onClick:()=>Ue(this._level)});_layout=y.border([y.hstack([y.vstack([ce([g.label("Pusherman",{textColor:"#b48000",fontSize:36,width:320}),this._continueButton,g.button("New Game",{fontSize:32,textColor:"#b48000",onClick:()=>He()}),this._importLevelsButton,this._resetLevelsButton])],{spacing:64}),g.flexSpace("horizontal"),y.vstack([g.flexSpace("vertical"),ce([g.label("Instructions",{fontSize:32,textColor:"#b48000"}),this._guideView,this._guideLabel])])])],{margin:y.margin(64,64,64,64)});constructor(){super(),this._layout.reshape(0,0,A,G),this._level=F.load(),this._continueButton.widget.isEnabled=this._level!=null;let e=localStorage.getItem("levels.xml");this._resetLevelsButton.widget.isEnabled=e!=null}async init(){this.startGuide()}deinit(){this.stopGuide()}update(e){for(let s of this._layout.widgets())s.update(e)}draw(e){for(let s of this._layout.widgets())s.draw(e)}startGuide(){const e=()=>{this._guideStep=(this._guideStep+1)%this._guide.length;const s=x.resolve(M),i=this._guide[this._guideStep];this._guideView.widget.image=s.getImage(i.imageName),this._guideLabel.widget.text=i.description,N.after(1,()=>e())};e()}stopGuide(){N.removeAllTimers()}updateUI(){F.reset(),this._continueButton.widget.isEnabled=!1;const e=localStorage.getItem("levels.xml");this._resetLevelsButton.widget.isEnabled=e!=null}resetLevels(){return new Promise((e,s)=>{localStorage.removeItem("levels.xml"),e()})}importLevels(){return F.reset(),new Promise((e,s)=>{const i=document.createElement("input");i.type="file",i.accept=".slc",i.style.display="none",i.onchange=()=>{const a=i.files?.[0];if(!a){s(new Error("No file selected"));return}const n=new FileReader;n.onload=()=>{var r=n.result;localStorage.setItem("levels.xml",r),e(),document.body.removeChild(i)},n.onerror=()=>{s(n.error),document.body.removeChild(i)},n.readAsText(a)},document.body.appendChild(i),i.click()})}}function ce(t){return y.border([g.panel(),y.border(y.vstack(t,{spacing:16}),{margin:y.margin(32,32,32,32)})],{stretch:"none"})}function He(){B.playSound("click5"),x.resolve(C).switch(new se(0))}function Ue(t){B.playSound("click5"),x.resolve(C).switch(new se(t))}async function Ve(){const t=x.resolve(M);await t.preload(),t.loadSpriteSheet("sokoban_spritesheet")}function je(){x.resolve(C).switch(new fe)}class Ye extends te{_isLoading=!1;_time=0;_suffix="";update(e){this._time+=e*3,this._suffix="";const s=Math.floor(this._time%4);for(let i=0;i<s;i++)this._suffix+=".";this._isLoading||(this._isLoading=!0,Ve().then(i=>je()))}draw(e){let s=`Loading${this._suffix}`;e.drawText(s,A/2,G/2,{align:"center",font:"32px fantasy"})}}class z{static showFps=!1;static showDraws=!1}class Ke{_sceneManager;_inputListener;_assetLoader;constructor(e){this._inputListener=new Q(e),x.register(Q,this._inputListener),this._sceneManager=new C(e.width,e.height),x.register(C,this._sceneManager),this._assetLoader=new M,x.register(M,this._assetLoader),g.init(e)}async init(){this._sceneManager.switch(new Ye)}update(e){this._sceneManager.update(e),this._inputListener.isInputReleased(L.ButtonL)&&(z.showFps=!z.showFps,z.showDraws=!z.showDraws),this._inputListener.update(),N.update(e),g.update()}draw(e){this._sceneManager.draw(e)}}const q=document.getElementById("game");q.width=A;q.height=G;document.body.appendChild(q);const Z=new Ke(q);await Z.init();const T=q.getContext("2d"),K=new ve(T);function pe(t){K.startFrame("#445555"),J.update(t,e=>Z.update(e)),Z.draw(K);{T.fillStyle="white",T.font="16px monospace";let e=20;z.showFps&&(T.fillText(`FPS: ${J.fps}`,10,e),e+=20),z.showDraws&&T.fillText(`Draws: ${K.drawCount}`,10,e)}requestAnimationFrame(pe)}requestAnimationFrame(pe);
